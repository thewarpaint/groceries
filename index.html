<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>¡Víveres!</title>
  <script src="//www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAWlwVDJmSi0TT4f5gfD1bQD62yJDIeEYg",
      authDomain: "groceries-6911d.firebaseapp.com",
      databaseURL: "https://groceries-6911d.firebaseio.com",
      storageBucket: "groceries-6911d.appspot.com",
      messagingSenderId: "849879024713"
    };

    firebase.initializeApp(config);
  </script>
  <script type="text/javascript">
    var groceriesRef;

    // Thresholds should be in descending order.
    // Last one should have the lowest number available to capture all other cases.

    var EDIBLE = 'edible',
        ABOUT_TO_EXPIRE = 'aboutToExpire',
        EXPIRED = 'expired';

    var thresholds = [
      { key: EDIBLE, delta: 3 },
      { key: ABOUT_TO_EXPIRE, delta: 0 },
      { key: EXPIRED, delta: Number.NEGATIVE_INFINITY }
    ];

    var i18n = {
      categories: {}
    };

    i18n.categories[EDIBLE] = 'Todo bien';
    i18n.categories[ABOUT_TO_EXPIRE] = 'Con cuidado...';
    i18n.categories[EXPIRED] = '¡Ya tíralo!';

    var MILLISECONDS_IN_DAY = 1000 * 60 * 60 * 24;

    var groceriesApp = {
      init: function () {
        newProductForm.reset();

        // It's only one user now, but let's assume we own the key `abc123`
        groceriesRef = firebase.database().ref('groceries/abc123');

        // TODO: Figure out how to send and receive more granular updates, not the whole list at once.
        groceriesRef.on('value', function (snapshot) {
          persistenceLayer.update(snapshot.val());
          categoryList.view.render(persistenceLayer.data);
        });
      }
    };

    var persistenceLayer = {
      data: {
        version: 1,
        products: []
      },

      save: function (data) {
        groceriesRef.set(persistenceLayer.convertToFirebaseObject(data));
      },

      update: function (data) {
        persistenceLayer.data = persistenceLayer.convertFromFirebaseObject(data);
      },

      convertToFirebaseObject: function (data) {
        return {
          version: data.version,
          products: data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getFormattedDate(product.expirationDate)
            };
          })
        };
      },

      convertFromFirebaseObject: function (data) {
        return {
          version: data.version,
          products: data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getDateFromString(product.expirationDate)
            };
          })
        };
      }
    };

    var newProductForm = {
      onSubmit: function (event) {
        var product = {
          uuid: uuidService.getNewUuid(),
          label: document.getElementById('new-product-label-field').value,
          expirationDate: dateService.getDateFromString(
            document.getElementById('new-product-expiration-date-field').value)
        };
        
        productList.add(product);
        newProductForm.reset();

        event.preventDefault();
      },

      reset: function () {
        var expirationDateField = document.getElementById('new-product-expiration-date-field');

        // Minimum expiration date is today, no expirations in the past.
        expirationDateField.min = dateService.getFormattedDate(new Date());

        // Default expiration date is (roughly) three days from now.
        expirationDateField.value = dateService.getFormattedDate(
          new Date((new Date()).getTime() + (MILLISECONDS_IN_DAY * 3)));

        document.getElementById('new-product-label-field').value = '';
      }
    };

    var productList = {
      view: {
        getHTML: function (products) {
          return '<ul>' + productList.view.getInnerHTML(products) + '</ul>';
        },

        getInnerHTML: function (products) {
          return products
            .sort(function (a, b) {
              return a.expirationDate.getTime() - b.expirationDate.getTime();
            })
            .map(function (product) {
              return productRenderer.getProductViewHTML(product);
            })
            .join('');
        },

        // Deprecated?
        render: function (products) {
          document.getElementById('product-list').innerHTML = productList.view.getInnerHTML(products);
        }
      },

      add: function (product) {
        // TODO: Figure out how to render just new products (either local ones or from Firebase),
        // not the whole list all the time.
        // productRenderer.addProduct(product);
        persistenceLayer.data.products.push(product);
        persistenceLayer.save(persistenceLayer.data);
      },

      remove: function (productUuid) {
        if(confirm('¿Estás seguro?')) {
          productList.doRemove(productUuid);
        }
      },

      doRemove: function (productUuid) {
        var index = null;

        for (var i = 0; i < persistenceLayer.data.products.length; i++) {
          if (persistenceLayer.data.products[i].uuid === productUuid) {
            index = i;
            break;
          }
        }

        if (index !== null) {
          persistenceLayer.data.products.splice(index, 1);
          persistenceLayer.save(persistenceLayer.data);
        }
      }
    };

    var productRenderer = {
      addProduct: function (product) {
        document.getElementById('product-list').innerHTML += productRenderer.getProductViewHTML(product);
      },

      getProductViewHTML: function (product) {
        return '<li id="' + product.uuid + '">' +
            productRenderer.getProductViewInnerHTML(product) + '</li>';
      },

      getProductViewInnerHTML: function (product) {
        var dateDelta = Math.ceil(dateService.getDelta(new Date(), product.expirationDate));
        var formattedDate = dateService.getHumanReadableDate(product.expirationDate);
        var html;

        html = '<h3>' + product.label + '</h3>';

        if (dateDelta === 0) {
          html += '<p>Caduca hoy.</p>';
        } else {
          if (dateDelta > 0) {
            html += '<p>Caduca en ' + dateDelta + ' día' + (dateDelta === 1 ? '' : 's');
          } else {
            dateDeltaAbsValue = Math.abs(dateDelta);
            html += '<p>Caducó hace ' + dateDeltaAbsValue + ' día' + (dateDeltaAbsValue === 1 ? '' : 's');
          }

          html += ', el ' + formattedDate + '.</p>';
        }

        html += '<button onclick="productList.remove(\'' + product.uuid + '\')">Borrar</button>';

        return html;
      }
    };

    var dateService = {
      months: [
        'Enero',
        'Febrero',
        'Marzo',
        'Abril',
        'Mayo',
        'Junio',
        'Julio',
        'Agosto',
        'Septiembre',
        'Octubre',
        'Noviembre',
        'Diciembre'
      ],
      getDelta: function (a, b) {
        return (b.getTime() - a.getTime()) / MILLISECONDS_IN_DAY;
      },
      getDayDeltaForTimestamps: function (timestampA, timestampB) {
        return (timestampB - timestampA) / MILLISECONDS_IN_DAY;
      },
      getHumanReadableDate: function (date) {
        return date.getDate() + ' de ' + dateService.months[date.getMonth()];
      },
      getFormattedDate: function (date) {
        var year = date.getFullYear(),
            month = date.getMonth() + 1,
            day = date.getDate();

        return year + '-' +
               (month < 10 ? '0' + month : month) + '-' +
               (day < 10 ? '0' + day : day);
      },
      getDateFromString: function (dateString) {
        var dateParts = dateString.split('-').map(function (s) {
          return parseInt(s, 10);
        });

        return new Date(dateParts[0], dateParts[1] - 1, dateParts [2]);
      },

      setDateToBeginningOfDay: function (date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);

        return date;
      }
    };

    var uuidService = {
      getNewUuid: function () {
        /**
         * Note: Not really a valid UUID/GUID, just a random placeholder for now.
         * From http://stackoverflow.com/a/105074
         */ 
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }


        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
      }
    };

    var categoryList = {
      view: {
        render: function (model) {
          document.getElementById('categories').innerHTML =
            categoryList.view.getHTML(categoryList.groupProductsByExpirationDate(model.products));
        },

        getHTML: function (categories) {
          return categories.map(function (category) {
              return '<h2>' + category.label + '</h2>' +
                productList.view.getHTML(category.products);
            })
            .join('');
        }
      },

      groupProductsByExpirationDate: function (products) {
        var productsByCategory = [];
        var productsByCategoryMap = {};

        thresholds.forEach(function (threshold) {
          var category = {
            label: i18n.categories[threshold.key],
            products: []
          };

          productsByCategory.push(category);

          // Auxiliary map to categorize products
          productsByCategoryMap[threshold.key] = category.products;
        });

        var delta, i;
        var nowTimestamp = dateService.setDateToBeginningOfDay(new Date()).getTime();

        products.forEach(function (product) {
          delta = dateService.getDayDeltaForTimestamps(nowTimestamp, product.expirationDate.getTime());

          for (i = 0; i < thresholds.length; i++) {
            if (delta >= thresholds[i].delta) {
              productsByCategoryMap[thresholds[i].key].push(product);
              break;
            }
          }
        });

        return productsByCategory.reverse();
      }
    };
  </script>
  <style type="text/css">
    input, button {
      padding: .5em;
    }

    .new-product-form__line {
      margin: .5em 0;
    }
  </style>
</head>
<body onload="groceriesApp.init()">
  <form onsubmit="newProductForm.onSubmit(event)" class="new-product-form">
    <p class="new-product-form__line">
      Compré
      <input type="text" name="label" id="new-product-label-field" placeholder="nombre del producto" required>
    </p>
    <p class="new-product-form__line">
      que caduca el
      <input type="date" name="expirationDate" id="new-product-expiration-date-field" required>.
    </p>

    <button type="submit">Agregar</button>
  </form>

  <div id="categories"></ul>
</body>
</html>
