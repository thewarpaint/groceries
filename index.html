<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>¡Víveres!</title>
  <script src="//www.gstatic.com/firebasejs/3.6.9/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAWlwVDJmSi0TT4f5gfD1bQD62yJDIeEYg",
      authDomain: "groceries-6911d.firebaseapp.com",
      databaseURL: "https://groceries-6911d.firebaseio.com",
      storageBucket: "groceries-6911d.appspot.com",
      messagingSenderId: "849879024713"
    };

    firebase.initializeApp(config);
  </script>
  <script type="text/javascript">
    var groceriesRef;

    var groceriesApp = {
      init: function () {
        newProductForm.reset();

        // It's only one user now, but let's assume we own the key `abc123`
        groceriesRef = firebase.database().ref('groceries/abc123');

        // TODO: Figure out how to send and receive more granular updates, not the whole list at once.
        groceriesRef.on('value', function (snapshot) {
          productList.update(snapshot.val());
          productListRenderer.render(persistenceLayer.data.products);
        });
      }
    };

    var persistenceLayer = {
      data: {
        version: 1,
        products: []
      },

      save: function (data) {
        groceriesRef.set(persistenceLayer.convertToFirebaseObject(data));
      },

      convertToFirebaseObject: function (data) {
        return {
          version: data.version,
          products: data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getFormattedDate(product.expirationDate)
            };
          })
        };
      },

      convertFromFirebaseObject: function (data) {
        return {
          version: data.version,
          products: data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getDateFromString(product.expirationDate)
            };
          })
        };
      }
    };

    var newProductForm = {
      onSubmit: function (event) {
        var product = {
          uuid: uuidService.getNewUuid(),
          label: document.getElementById('new-product-label-field').value,
          expirationDate: dateService.getDateFromString(
            document.getElementById('new-product-expiration-date-field').value)
        };
        
        productList.add(product);
        newProductForm.reset();

        event.preventDefault();
      },

      reset: function () {
        var expirationDateField = document.getElementById('new-product-expiration-date-field');

        // Minimum expiration date is today, no expirations in the past.
        expirationDateField.min = dateService.getFormattedDate(new Date());

        // Default expiration date is (roughly) three days from now.
        expirationDateField.value = dateService.getFormattedDate(
          new Date((new Date()).getTime() + (1000 * 60 * 60 * 24 * 3)));

        document.getElementById('new-product-label-field').value = '';
      }
    };

    var productList = {
      add: function (product) {
        // TODO: Figure out how to render just new products (either local ones or from Firebase),
        // not the whole list all the time.
        // productRenderer.addProduct(product);
        persistenceLayer.data.products.push(product);
        persistenceLayer.save(persistenceLayer.data);
      },

      remove: function (productUuid) {
        if(confirm('¿Estás seguro?')) {
          productList.doRemove(productUuid);
        }
      },

      doRemove: function (productUuid) {
        var index = null;

        for (var i = 0; i < persistenceLayer.data.products.length; i++) {
          if (persistenceLayer.data.products[i].uuid === productUuid) {
            index = i;
            break;
          }
        }

        if (index !== null) {
          persistenceLayer.data.products.splice(index, 1);
          persistenceLayer.save(persistenceLayer.data);
        }
      },

      update: function (data) {
        persistenceLayer.data = persistenceLayer.convertFromFirebaseObject(data);
      }
    };

    var productRenderer = {
      addProduct: function (product) {
        document.getElementById('product-list').innerHTML += productRenderer.getProductViewHTML(product);
      },

      getProductViewHTML: function (product) {
        return '<li id="' + product.uuid + '">' +
            productRenderer.getProductViewInnerHTML(product) + '</li>';
      },

      getProductViewInnerHTML: function (product) {
        var dateDelta = Math.ceil(dateService.getDelta(new Date(), product.expirationDate));
        var formattedDate = dateService.getHumanReadableDate(product.expirationDate);

        return '<h3>' + product.label + '</h3>' +
          '<p>Caduca en ' + dateDelta + ' día' + (dateDelta === 1 ? '' : 's') +
            ', el ' + formattedDate + '.</p>' +
          '<button onclick="productList.remove(\'' + product.uuid + '\')">Borrar</button>';
      }
    };

    var productListRenderer = {
      render: function (products) {
        document.getElementById('product-list').innerHTML = products
          .sort(function (a, b) {
            return a.expirationDate.getTime() - b.expirationDate.getTime();
          })
          .map(function (product) {
            return productRenderer.getProductViewHTML(product);
          })
          .join('');
      }
    };

    var dateService = {
      months: [
        'Enero',
        'Febrero',
        'Marzo',
        'Abril',
        'Mayo',
        'Junio',
        'Julio',
        'Agosto',
        'Septiembre',
        'Octubre',
        'Noviembre',
        'Diciembre'
      ],
      getDelta: function (a, b) {
        return (b.getTime() - a.getTime())/(1000*60*60*24);
      },
      getHumanReadableDate: function (date) {
        return date.getDate() + ' de ' + dateService.months[date.getMonth()];
      },
      getFormattedDate: function (date) {
        var year = date.getFullYear(),
            month = date.getMonth() + 1,
            day = date.getDate();

        return year + '-' +
               (month < 10 ? '0' + month : month) + '-' +
               (day < 10 ? '0' + day : day);
      },
      getDateFromString: function (dateString) {
        var dateParts = dateString.split('-').map(function (s) {
          return parseInt(s, 10);
        });

        return new Date(dateParts[0], dateParts[1] - 1, dateParts [2]);
      }
    };

    var uuidService = {
      getNewUuid: function () {
        /**
         * Note: Not really a valid UUID/GUID, just a random placeholder for now.
         * From http://stackoverflow.com/a/105074
         */ 
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }


        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
      }
    };
  </script>
  <style type="text/css">
    input, button {
      padding: .5em;
    }
  </style>
</head>
<body onload="groceriesApp.init()">
  <form onsubmit="newProductForm.onSubmit(event)">
    Compré <input type="text" name="label" id="new-product-label-field" placeholder="nombre del producto"
      required><br>
    que caduca el
      <input type="date" name="expirationDate" id="new-product-expiration-date-field" required>.<br>

    <button type="submit">Agregar</button>
  </form>

  <ul id="product-list"></ul>
</body>
</html>
