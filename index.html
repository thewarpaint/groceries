<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>¡Víveres!</title>
  <script src="//www.gstatic.com/firebasejs/3.7.1/firebase.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyAWlwVDJmSi0TT4f5gfD1bQD62yJDIeEYg",
      authDomain: "groceries-6911d.firebaseapp.com",
      databaseURL: "https://groceries-6911d.firebaseio.com",
      storageBucket: "groceries-6911d.appspot.com",
      messagingSenderId: "849879024713"
    };

    firebase.initializeApp(config);
  </script>
  <script type="text/javascript">
    var groceriesRef;

    // Thresholds should be in descending order.
    // Last one should have the lowest number available to capture all other cases.

    var EDIBLE = 'edible',
        ABOUT_TO_EXPIRE = 'aboutToExpire',
        EXPIRED = 'expired';

    var thresholds = [
      { key: EDIBLE, delta: 3 },
      { key: ABOUT_TO_EXPIRE, delta: 0 },
      { key: EXPIRED, delta: Number.NEGATIVE_INFINITY }
    ];

    var i18n = {
      categories: {},
      products: {
        actions: {
          add: 'Agregar',
          cancel: 'Cancelar',
          delete: 'Borrar',
          edit: 'Editar',
          save: 'Guardar'
        },
        emptyState: {
          intro: 'No hay productos en esta categoría.',
          callToAction: '¿Deseas agregar uno?'
        }
      }
    };

    i18n.categories[EDIBLE] = 'Todo bien';
    i18n.categories[ABOUT_TO_EXPIRE] = 'Con cuidado...';
    i18n.categories[EXPIRED] = '¡Ya tíralo!';

    var MILLISECONDS_IN_DAY = 1000 * 60 * 60 * 24;

    // Save query params when loaded and update as needed.
    // From http://stackoverflow.com/a/2880929
    var urlParams;

    (window.onpopstate = function () {
        var match,
          pl     = /\+/g,  // Regex for replacing addition symbol with a space
          search = /([^&=]+)=?([^&]*)/g,
          decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
          query  = window.location.search.substring(1);

        urlParams = {};
        while (match = search.exec(query)) {
          urlParams[decode(match[1])] = decode(match[2]);
        }
    })();

    var groceriesApp = {
      init: function () {
        var account = urlParams.account;
        var model;

        if (account) {
          // Account is defined in the URL, save in localStorage for the next time.
          LocalStorageLayer.set('groceriesData', { account: account });
        } else {
          // Try to get account from localStorage.
          model = LocalStorageLayer.get('groceriesData');

          if (model) {
            account = model.account;
          }

          if (!account) {
            console.warn('Couldn\'t get account, falling back to \'demo\'.');
            account = 'demo';
          }
        }

        ProductForm.init();

        // It's only one user now, but let's assume we own the key `abc123`
        groceriesRef = firebase.database().ref('groceries/' + account);

        // TODO: Figure out how to send and receive more granular updates, not the whole list at once.
        groceriesRef.on('value', function (snapshot) {
          persistenceLayer.update(snapshot.val());
          categoryList.view.render(persistenceLayer.data);
        });
      }
    };

    var persistenceLayer = {
      data: {
        version: 1,
        products: []
      },

      save: function (data) {
        groceriesRef.set(persistenceLayer.convertToFirebaseObject(data));
      },

      update: function (data) {
        persistenceLayer.data = persistenceLayer.convertFromFirebaseObject(data);
      },

      convertToFirebaseObject: function (data) {
        return {
          version: data.version,
          products: data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getFormattedDate(product.expirationDate)
            };
          })
        };
      },

      convertFromFirebaseObject: function (data) {
        var model = {
          version: data.version,
          products: []
        };

        if (data.products && data.products.length > 0) {
          model.products = data.products.map(function (product) {
            return {
              uuid: product.uuid,
              label: product.label,
              expirationDate: dateService.getDateFromString(product.expirationDate)
            };
          });
        }

        return model;
      }
    };

    var LocalStorageLayer = {
      get: function (key) {
        try {
          return JSON.parse(localStorage.getItem(key));
        } catch (e) {
          console.error('Couldn\'t get localStorage key:', key, e);
          return null;
        }
      },

      set: function (key, value) {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error('Couldn\'t set localStorage key:', key, ', value:', value, e);
        }
      }
    };

    var ProductForm = {
      elements: {
        add: null,
        cancel: null,
        expirationDate: null,
        form: null,
        label: null,
        uuid: null,
        save: null
      },

      init: function () {
        ProductForm.elements.form = document.getElementById('product-form');

        ProductForm.elements.expirationDate = document.getElementById('product-expiration-date-field');
        ProductForm.elements.label = document.getElementById('product-label-field');
        ProductForm.elements.uuid = document.getElementById('product-uuid-field');

        ProductForm.elements.add = document.getElementById('product-add-button');
        ProductForm.elements.cancel = document.getElementById('product-cancel-button');
        ProductForm.elements.save = document.getElementById('product-save-button');
        ProductForm.elements.datePlus = document.getElementById('product-date-plus-button');
        ProductForm.elements.dateMinus = document.getElementById('product-date-minus-button');

        ProductForm.elements.add.textContent = i18n.products.actions.add;
        ProductForm.elements.cancel.textContent = i18n.products.actions.cancel;
        ProductForm.elements.save.textContent = i18n.products.actions.save;

        ProductForm.reset();
      },

      onSubmit: function (event) {
        var product = ProductForm.getData();

        if (product.uuid) {
          ProductList.update(product);
          ProductForm.setEditMode(false);
        } else {
          product.uuid = uuidService.getNewUuid();
          ProductList.add(product);
        }

        ProductForm.reset();
        event.preventDefault();
      },

      edit: function (product) {
        var data = {
          editMode: true,
          expirationDate: product.expirationDate,
          label: product.label,
          minExpirationDate: null,
          uuid: product.uuid
        };

        ProductForm.setData(data);
        ProductForm.focus();
      },

      reset: function () {
        var now = new Date();
        var threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(threeDaysFromNow.getDate() + 3);

        // Minimum expiration date is today, no expirations in the past.
        // Default expiration date is three days from now.
        var data = {
          editMode: false,
          expirationDate: threeDaysFromNow,
          label: '',
          minExpirationDate: now,
          uuid: ''
        };

        ProductForm.setData(data);
      },

      getData: function () {
        return {
          editMode: ProductForm.elements.form.classList.contains('product-form--edit'),
          expirationDate: dateService.getDateFromString(ProductForm.elements.expirationDate.value),
          label: ProductForm.elements.label.value,
          minExpirationDate: dateService.getDateFromString(ProductForm.elements.expirationDate.min),
          uuid: ProductForm.elements.uuid.value
        }
      },

      setData: function (data) {
        ProductForm.elements.expirationDate.value = dateService.getFormattedDate(data.expirationDate);
        ProductForm.elements.label.value = data.label;
        ProductForm.elements.uuid.value = data.uuid;

        if (data.minExpirationDate) {
          ProductForm.elements.expirationDate.min = dateService.getFormattedDate(data.minExpirationDate);
          ProductForm.elements.dateMinus.disabled =
            data.expirationDate.getTime() === data.minExpirationDate.getTime();
        } else {
          ProductForm.elements.expirationDate.min = '';
          ProductForm.elements.dateMinus.disabled = false;
        }

        ProductForm.setEditMode(data.editMode);
      },

      focus: function () {
        ProductForm.elements.label.focus();
      },

      setEditMode: function (editMode) {
        if (editMode) {
          ProductForm.elements.form.classList.add('product-form--edit');
          ProductForm.elements.form.classList.remove('product-form--add');
        } else {
          ProductForm.elements.form.classList.add('product-form--add');
          ProductForm.elements.form.classList.remove('product-form--edit');
        }
      },

      changeDay: function (delta) {
        var data = ProductForm.getData();
        var newExpirationDate = new Date(data.expirationDate.getTime());

        newExpirationDate.setDate(data.expirationDate.getDate() + delta);

        if (!data.minExpirationDate || newExpirationDate >= data.minExpirationDate) {
          data.expirationDate = newExpirationDate;
        }

        ProductForm.setData(data);
      }
    };

    var ProductList = {
      view: {
        getHTML: function (products) {
          if (products.length === 0) {
            return i18n.products.emptyState.intro + ' <a href="#" class="link" onclick="ProductForm.focus()">' +
              i18n.products.emptyState.callToAction + '</a>';
          }

          return '<ul class="product-list">' + ProductList.view.getInnerHTML(products) + '</ul>';
        },

        getInnerHTML: function (products) {
          return products
            .sort(function (a, b) {
              return a.expirationDate.getTime() - b.expirationDate.getTime();
            })
            .map(function (product) {
              return productRenderer.getProductViewHTML(product);
            })
            .join('');
        },

        // Deprecated?
        render: function (products) {
          document.getElementById('product-list').innerHTML = ProductList.view.getInnerHTML(products);
        }
      },

      add: function (product) {
        // TODO: Figure out how to render just new products (either local ones or from Firebase),
        // not the whole list all the time.
        // productRenderer.addProduct(product);
        persistenceLayer.data.products.push(product);
        persistenceLayer.save(persistenceLayer.data);
      },

      edit: function (productUuid) {
        var product = ProductList.findByUuid(productUuid);

        if (typeof product !== 'undefined') {
          ProductForm.edit(product);
        }
      },

      update: function (newProduct) {
        var productIndex = ProductList.findIndexByUuid(newProduct.uuid);

        if (typeof productIndex === -1) {
          console.error('Unable to update product', newProduct);
        }

        persistenceLayer.data.products[productIndex] = newProduct;
        persistenceLayer.save(persistenceLayer.data);
      },

      remove: function (productUuid) {
        if(confirm('¿Estás seguro?')) {
          ProductList.doRemove(productUuid);
        }
      },

      doRemove: function (productUuid) {
        var index = null;

        for (var i = 0; i < persistenceLayer.data.products.length; i++) {
          if (persistenceLayer.data.products[i].uuid === productUuid) {
            index = i;
            break;
          }
        }

        if (index !== null) {
          persistenceLayer.data.products.splice(index, 1);
          persistenceLayer.save(persistenceLayer.data);
        }
      },

      findByUuid: function (uuid) {
        return persistenceLayer.data.products.find(function (product) {
          return product.uuid === uuid;
        })
      },

      findIndexByUuid: function (uuid) {
        return persistenceLayer.data.products.findIndex(function (product) {
          return product.uuid === uuid;
        })
      }
    };

    var productRenderer = {
      addProduct: function (product) {
        document.getElementById('product-list').innerHTML += productRenderer.getProductViewHTML(product);
      },

      getProductViewHTML: function (product) {
        return '<li id="product-' + product.uuid + '" class="product">' +
            productRenderer.getProductViewInnerHTML(product) + '</li>';
      },

      getProductViewInnerHTML: function (product) {
        var dateDelta = Math.ceil(dateService.getDelta(new Date(), product.expirationDate));
        var formattedDate = dateService.getHumanReadableDate(product.expirationDate);
        var html;

        html = '<h3 class="product__header">' + product.label + '</h3>';

        if (dateDelta === 0) {
          html += '<p>Caduca hoy.</p>';
        } else {
          if (dateDelta > 0) {
            html += '<p>Caduca en ' + dateDelta + ' día' + (dateDelta === 1 ? '' : 's');
          } else {
            dateDeltaAbsValue = Math.abs(dateDelta);
            html += '<p>Caducó hace ' + dateDeltaAbsValue + ' día' + (dateDeltaAbsValue === 1 ? '' : 's');
          }

          html += ', el ' + formattedDate + '.</p>';
        }

        html += '<div class="product__actions">' +
                  '<button class="product__action" onclick="ProductList.edit(\'' + product.uuid + '\')">' +
                    i18n.products.actions.edit + '</button>' +
                  '<button class="product__action" onclick="ProductList.remove(\'' + product.uuid + '\')">' +
                    i18n.products.actions.delete + '</button>' +
                '</div>';

        return html;
      }
    };

    var dateService = {
      months: [
        'Enero',
        'Febrero',
        'Marzo',
        'Abril',
        'Mayo',
        'Junio',
        'Julio',
        'Agosto',
        'Septiembre',
        'Octubre',
        'Noviembre',
        'Diciembre'
      ],
      getDelta: function (a, b) {
        return (b.getTime() - a.getTime()) / MILLISECONDS_IN_DAY;
      },
      getDayDeltaForTimestamps: function (timestampA, timestampB) {
        return (timestampB - timestampA) / MILLISECONDS_IN_DAY;
      },
      getHumanReadableDate: function (date) {
        return date.getDate() + ' de ' + dateService.months[date.getMonth()];
      },
      getFormattedDate: function (date) {
        var year = date.getFullYear(),
            month = date.getMonth() + 1,
            day = date.getDate();

        return year + '-' +
               (month < 10 ? '0' + month : month) + '-' +
               (day < 10 ? '0' + day : day);
      },

      getDateFromString: function (dateString) {
        if (!dateString) {
          return null;
        }

        var dateParts = dateString.split('-').map(function (s) {
          return parseInt(s, 10);
        });

        return new Date(dateParts[0], dateParts[1] - 1, dateParts [2]);
      },

      setDateToBeginningOfDay: function (date) {
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);

        return date;
      }
    };

    var uuidService = {
      getNewUuid: function () {
        /**
         * Note: Not really a valid UUID/GUID, just a random placeholder for now.
         * From http://stackoverflow.com/a/105074
         */ 
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
            .toString(16)
            .substring(1);
        }


        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
          s4() + '-' + s4() + s4() + s4();
      }
    };

    var categoryList = {
      view: {
        render: function (model) {
          document.getElementById('category-list').innerHTML =
            categoryList.view.getHTML(categoryList.groupProductsByExpirationDate(model.products));
        },

        getHTML: function (categories) {
          return categories.map(function (category) {
              return '<div class="category">' +
                        '<h2 class="category__header">' + category.label + '</h2>' +
                        ProductList.view.getHTML(category.products) +
                      '</div>';
            })
            .join('');
        }
      },

      groupProductsByExpirationDate: function (products) {
        var productsByCategory = [];
        var productsByCategoryMap = {};

        thresholds.forEach(function (threshold) {
          var category = {
            label: i18n.categories[threshold.key],
            products: []
          };

          productsByCategory.push(category);

          // Auxiliary map to categorize products
          productsByCategoryMap[threshold.key] = category.products;
        });

        var delta, i;
        var nowTimestamp = dateService.setDateToBeginningOfDay(new Date()).getTime();

        products.forEach(function (product) {
          delta = dateService.getDayDeltaForTimestamps(nowTimestamp, product.expirationDate.getTime());

          for (i = 0; i < thresholds.length; i++) {
            if (delta >= thresholds[i].delta) {
              productsByCategoryMap[thresholds[i].key].push(product);
              break;
            }
          }
        });

        return productsByCategory.reverse();
      }
    };
  </script>
  <style type="text/css">
    input, button, .btn {
      padding: .5em;
    }

    .product-form--add .product-form__action-save, .product-form--add .product-form__action-cancel {
      display: none;
    }

    .product-form--edit .product-form__action-add {
      display: none;
    }

    .product-form__line {
      margin: .5em 0;
    }

    .category {
      margin-bottom: 3em;
    }

    .category__header {
      font-size: 1.25em;
    }

    .product-list {
      padding-left: 0;
      list-style-type: none;
    }

    .product__header {
      font-size: 1.125em;
    }

    .product-form__action:not(:last-child), .product__action:not(:last-child) {
      margin-right: 1em;
    }
  </style>
</head>
<body onload="groceriesApp.init()">
  <form onsubmit="ProductForm.onSubmit(event)" id="product-form" class="product-form product-form--add">
    <p class="product-form__line">
      Compré
      <input type="text" name="label" id="product-label-field" placeholder="nombre del producto" required>
    </p>
    <p class="product-form__line">
      que caduca el
      <button type="button" class="btn" id="product-date-minus-button" onclick="ProductForm.changeDay(-1);">-
        </button>
      <input type="date" name="expirationDate" id="product-expiration-date-field" required>
      <button type="button" class="btn" id="product-date-plus-button" onclick="ProductForm.changeDay(+1);">+
        </button>.
    </p>

    <input type="hidden" id="product-uuid-field" name="productUuid" value="">

    <div class="product-form__actions">
      <button type="submit" id="product-add-button"
        class="product-form__action product-form__action-add"></button>
      <button type="submit" id="product-save-button"
        class="product-form__action product-form__action-save"></button>
      <button type="button" id="product-cancel-button" onclick="ProductForm.reset()"
        class="product-form__action product-form__action-cancel"></button>
    </div>
  </form>

  <div id="category-list"></ul>
</body>
</html>
